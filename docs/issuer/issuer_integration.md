# Issuer Adapter

This article details the APIs exposed by the issuer adapter for the issuer to consume, and the APIs that the issuer adapter expects to be able to access on the issuer.

The issuer adapter supports issuers with two types of authentication: 
- Issuers may perform user-facing authentication themselves, providing an opaque token to the issuer-adapter (through an oauth-like redirect and backchannel flow) for authenticating credential data requests for the given user.
- Or, the issuer may integrate with an OIDC provider, which the issuer-adapter will use to get user consent for an access token and refresh token, which it uses to authenticate credential data requests for the given user.

## 1 Issuer Adapter APIs
This section contains the details of Issuer Adapter APIs to be consumed by the Issuer.

### 1.1 Create Profile API - HTTP POST /profile

Creates a new Issuer profile with Adapter.

#### Request 
- `id`: profile id
- `name`: human-readable profile name
- `supportedVCContexts` : VC contexts supported by the issuer
- `url`: issuer service callback urls
- `supportsAssuranceCredential`: flag for issuer assurance support - [refer](#24-user-data-api---http-post-urlfromissuerprofileassurance)
- `requiresBlindedRoute`: flag for blinded routing feat - [refer](../blinded_routing.md)
- `oidcProvider`: the URL of the OIDC provider that the issuer is integrated with. Required if the issuer adapter is intended to use OIDC authorization with this issuer.
- `scopes`: a json array of strings, each of which names a scope that the issuer-adapter will be allowed to request. May include custom scopes to scope out specific credential read permissions. Mandatory if `oidcProvider` exists, and must then contain at least one value.
- `oidcParams`: client parameters for the issuer-adapter to use with this profile. Always optional, only read if `oidcProvider` is also set. If this is not present, the issuer-adapter will attempt to use dynamic client registration to register with the OIDC provider.
  - `client_id`: the Oauth 2.0 client ID to use. Must be present if `oidcParams` exists.
  - `client_secret`: the Oauth 2.0 client secret to use. Must be present if `oidcParams` exists.
  - `client_secret_expires_at`: the time at which the client secret expires, or 0 if it will not expire. Time is in seconds since january 01, 1970, 00:00:00 UTC. Must be present if `oidcParams` exists.

```
{
   "id":"2cb3d5e0-de69-4418-b673-4e37ad1d0775",
   "name":"Issuer Profile 1",
   "supportedVCContexts":[
      "https://w3id.org/citizenship/v3"
   ],
   "url":"http://issuer.example.com",
   "supportsAssuranceCredential":false,
   "requiresBlindedRoute":true,
   "oidcProvider":"example-oidc-provider.com",
   "scopes":["example_cred_data", "example_assurance_cred"],
   "oidcParams": {
      "client_id":"abcdefg_client_id",
      "client_secret":"abcdefg",
      "client_secret_expires_at": 0
   }
}
```

#### Response
```
{
   "id":"2cb3d5e0-de69-4418-b673-4e37ad1d0775",
   "name":"Issuer Profile 1",
   "url":"http://issuer.example.com",
   "supportedVCContexts":[
      "https://w3id.org/citizenship/v3"
   ],
   "supportsAssuranceCredential":false,
   "requiresBlindedRoute":true,
   "credentialSigningKey":"did:example:def567#key1",
   "presentationSigningKey":"did:example:def567#key1",
   "createdAt":"2020-07-27T14:31:04.250212Z"
}
```

### 1.2 Retrieve Profile API - HTTP GET /profile/{profileID}
Retrieves the issuer profile

#### Response
```
{
   "id":"2cb3d5e0-de69-4418-b673-4e37ad1d0775",
   "name":"Issuer Profile 1",
   "url":"http://issuer.example.com",
   "supportedVCContexts":[
      "https://w3id.org/citizenship/v3"
   ],
   "supportsAssuranceCredential":false,
   "oidcProvider":"example-oidc-provider.com",
   "scopes":["example_cred_data", "example_assurance_cred"],
   "oidcParams": {
      "client_id":"abcdefg_client_id",
      "client_secret":"abcdefg",
      "client_secret_expires_at": 0
   },
   "credentialSigningKey":"did:example:def567#key1",
   "presentationSigningKey":"did:example:def567#key1",
   "createdAt":"2020-07-27T14:31:04.250212Z"
}
```


### 1.3 Wallet Connect API - HTTP Redirect /{profileID}/connect/wallet
Redirect API to connect Issuer to Wallet through Issuer Adapter. Once connected, the issuer adapter will redirect to Issuer callback url.

Exactly one of two URL query parameters must be present, this determines whether the issuer-adapter will redirect for an OIDC login & consent itself, or request an authentication token from the issuer directly.
- `state`: unique ID generated by the issuer for tracking the session. The unmodified value will be sent back to the Issuer when requesting the token. This is for the issuer-provided token flow.
- `cred`: the scope of the credential data that the issuer-adapter is to request permission (through a redirect to the OIDC provider) to access. This value must be one of the `scopes` values set for this issuer profile in profile registration.

## 2 Issuer APIs
This section contains the details of the APIs that need to be exposed by the Issuer to be consumed by Issuer Adapter.

### 2.1 Get Issuer Token API - HTTP POST <urlFromIssuerProfile>/token

This endpoint must be implemented by issuers that use the issuer-provided-token flow.

#### Request 
```
{
   "state":"2a445655-2f36-4e26-b7fc-6811f2d6051d"
}
```
- `state`: unmodified value from the issuer received by the adapter during wallet connect.

#### Response 
```
{
   "token":"4e725916-1992-4765-aadd-85a96e76aeaa"
}
```
- `token`: This will be used by adapter to get the user data from the issuer.

### 2.2 Wallet Connect Callback API - HTTP REDIRECT <urlFromIssuerProfile>/cb?state={state}
state: unmodified value from the issuer received by the adapter during wallet connect. Optional.

[TODO - Send wallet connect error to issuer](https://github.com/trustbloc/edge-adapter/issues/213)

### 2.3 User Data API - HTTP POST <urlFromIssuerProfile>/data
When RP asks for the user credential, the Issuer adapter calls this API to get the user data from the issuer and creates a VC.

#### Request
A request must contain exactly one of the following:
- An `Authorization` header containing a `Bearer` token, holding the Oauth 2.0 token provided by the issuer's OIDC provider, specifically for a given (set of) credential scope(s) and wallet connection.
- A json payload, containing a `token` field, which holds the issuer-provided token value for a particular issuer profile and wallet connection.

```
{
   "token":"2a445655-2f36-4e26-b7fc-6811f2d6051d"
}
```

#### Response
```
{
   "data":{
      "user data"
   },
   "metadata":{
      "contexts":[
         "<json-ld contexts>"
      ],
      "scopes":[
         "<json-ld scopes>"
      ],
      "name":"<name>",
      "description":"<description>"
   }
}
```

##### Sample Response
```
{
   "data":{
      "id":"did:example:b34ca6cd37bbf23",
      "givenName":"JOHN",
      "familyName":"SMITH",
      "gender":"Male",
      "image":"data:image/png;base64,iVBORw0KGgo...kJggg==",
      "residentSince":"2015-01-01",
      "lprCategory":"C09",
      "lprNumber":"999-999-999",
      "commuterClassification":"C1",
      "birthCountry":"Bahamas",
      "birthDate":"1958-07-17"
   },
   "metadata":{
      "contexts":[
         "https://w3id.org/citizenship/v1"
      ],
      "scopes":[
         "PermanentResidentCard"
      ],
      "name":"Permanent Residence Card",
      "description":"Permanent Residence Card for John Smith (Issued by Government of Wonderland)"
   }
}
```

### 2.4 User Data API - HTTP POST <urlFromIssuerProfile>/assurance
When RP asks for the user assurance data, the Issuer adapter calls this API to get the assurance data from the issuer and creates a VC.
Note: This API is applicable when Issuer supports assurance credential - [refer](#11-create-profile-api---http-post-profile)

#### Request 
A request must contain exactly one of the following:
- An `Authorization` header containing a `Bearer` token, holding the Oauth 2.0 token provided by the issuer's OIDC provider, specifically for a given (set of) credential scope(s) and wallet connection.
- A json payload, containing a `token` field, which holds the issuer-provided token value for a particular issuer profile and wallet connection.

```
{
   "token":"2a445655-2f36-4e26-b7fc-6811f2d6051d"
}
```

#### Response
```
{
   "data":{
      "user data"
   },
   "metadata":{
      "contexts":[
         "<json-ld contexts>"
      ],
      "scopes":[
         "<json-ld scopes>"
      ],
      "name":"<name>",
      "description":"<description>"
   }
}
```

##### Sample Response
```
{
   "data":{
      "document_number":"123-456-789",
      "evidence_id":"d4d18a776cc6",
      "comments":"DL verified digitally"
   },
   "metadata":{
      "contexts":[
         "https://trustbloc.github.io/context/vc/examples/driver-license-evidence-v1.jsonld"
      ],
      "scopes":[
         "DrivingLicenseEvidence"
      ],
      "name":"Drivers License Evidence",
      "description":"Drivers License Evidence for John Smith"
   }
}
```
